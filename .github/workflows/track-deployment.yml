name: Track DORA Metrics - Deployment

on:
  # Executa automaticamente quando houver push na branch master (branch principal do projeto)
  push:
    branches:
      - master

  # Permite execuÃ§Ã£o manual para registrar falhas
  workflow_dispatch:
    inputs:
      deployment_status:
        description: 'Status do deployment (success ou failure)'
        required: true
        default: 'success'
        type: choice
        options:
          - success
          - failure

jobs:
  track-deployment:
    name: Registrar Deployment
    runs-on: ubuntu-24.04
    # SÃ³ registra deployment se os testes passarem (exceto quando executado manualmente)
    needs: []

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Busca todo o histÃ³rico para calcular lead time

      - name: Obter informaÃ§Ãµes do commit
        id: commit-info
        run: |
          #!/bin/bash
          set -euo pipefail

          # Pega o SHA do commit atual
          COMMIT_SHA="${{ github.sha }}"

          # Pega o timestamp do commit (quando foi feito)
          # Usa formato ISO 8601 compatÃ­vel com diferentes sistemas
          COMMIT_TIMESTAMP=$(git show -s --format=%cI "$COMMIT_SHA")

          # Timestamp atual (momento do deployment)
          DEPLOYMENT_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Status do deployment
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            DEPLOYMENT_STATUS="${{ inputs.deployment_status }}"
          else
            DEPLOYMENT_STATUS="success"
          fi

          # InformaÃ§Ãµes do branch
          BRANCH_NAME="${{ github.ref_name }}"

          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_timestamp=$COMMIT_TIMESTAMP" >> $GITHUB_OUTPUT
          echo "deployment_timestamp=$DEPLOYMENT_TIMESTAMP" >> $GITHUB_OUTPUT
          echo "deployment_status=$DEPLOYMENT_STATUS" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          echo "ðŸ“Š InformaÃ§Ãµes do Deployment:"
          echo "   Branch: $BRANCH_NAME"
          echo "   Commit: $COMMIT_SHA"
          echo "   Commit feito em: $COMMIT_TIMESTAMP"
          echo "   Deploy realizado em: $DEPLOYMENT_TIMESTAMP"
          echo "   Status: $DEPLOYMENT_STATUS"

      - name: Calcular Lead Time
        id: lead-time
        run: |
          #!/bin/bash
          set -euo pipefail

          COMMIT_TIME="${{ steps.commit-info.outputs.commit_timestamp }}"
          DEPLOY_TIME="${{ steps.commit-info.outputs.deployment_timestamp }}"

          # Converte para segundos usando formato Unix timestamp
          COMMIT_SECONDS=$(date -d "$COMMIT_TIME" +%s)
          DEPLOY_SECONDS=$(date -d "$DEPLOY_TIME" +%s)

          # Calcula diferenÃ§a
          LEAD_TIME_SECONDS=$((DEPLOY_SECONDS - COMMIT_SECONDS))
          LEAD_TIME_MINUTES=$((LEAD_TIME_SECONDS / 60))
          LEAD_TIME_HOURS=$((LEAD_TIME_MINUTES / 60))

          echo "lead_time_seconds=$LEAD_TIME_SECONDS" >> $GITHUB_OUTPUT
          echo "lead_time_minutes=$LEAD_TIME_MINUTES" >> $GITHUB_OUTPUT

          echo "â±ï¸  Lead Time para MudanÃ§as:"
          if [ $LEAD_TIME_HOURS -gt 0 ]; then
            echo "   $LEAD_TIME_HOURS horas e $((LEAD_TIME_MINUTES % 60)) minutos"
          else
            echo "   $LEAD_TIME_MINUTES minutos ($LEAD_TIME_SECONDS segundos)"
          fi

      - name: Enviar dados para a API
        id: send-metrics
        env:
          BACKEND_URL: ${{ secrets.BACKEND_API_URL }}
          PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          #!/bin/bash
          set -euo pipefail

          # Validar que os secrets estÃ£o configurados
          if [ -z "$BACKEND_URL" ]; then
            echo "âŒ ERRO: Secret BACKEND_API_URL nÃ£o configurado"
            echo "Configure em: Settings > Secrets and variables > Actions"
            exit 1
          fi

          if [ -z "$PROJECT_KEY" ]; then
            echo "âŒ ERRO: Secret SONAR_PROJECT_KEY nÃ£o configurado"
            echo "Configure em: Settings > Secrets and variables > Actions"
            exit 1
          fi

          # Preparar payload JSON
          PAYLOAD=$(cat <<'EOF'
          {
            "projectKey": "PROJECT_KEY_PLACEHOLDER",
            "commitSha": "COMMIT_SHA_PLACEHOLDER",
            "commitTimestamp": "COMMIT_TIMESTAMP_PLACEHOLDER",
            "deploymentTimestamp": "DEPLOYMENT_TIMESTAMP_PLACEHOLDER",
            "status": "STATUS_PLACEHOLDER",
            "branch": "BRANCH_PLACEHOLDER",
            "leadTimeSeconds": LEAD_TIME_SECONDS_PLACEHOLDER,
            "repository": "REPOSITORY_PLACEHOLDER",
            "workflowRun": "WORKFLOW_RUN_PLACEHOLDER"
          }
          EOF
          )

          # Substituir placeholders
          PAYLOAD="${PAYLOAD//PROJECT_KEY_PLACEHOLDER/$PROJECT_KEY}"
          PAYLOAD="${PAYLOAD//COMMIT_SHA_PLACEHOLDER/${{ steps.commit-info.outputs.commit_sha }}}"
          PAYLOAD="${PAYLOAD//COMMIT_TIMESTAMP_PLACEHOLDER/${{ steps.commit-info.outputs.commit_timestamp }}}"
          PAYLOAD="${PAYLOAD//DEPLOYMENT_TIMESTAMP_PLACEHOLDER/${{ steps.commit-info.outputs.deployment_timestamp }}}"
          PAYLOAD="${PAYLOAD//STATUS_PLACEHOLDER/${{ steps.commit-info.outputs.deployment_status }}}"
          PAYLOAD="${PAYLOAD//BRANCH_PLACEHOLDER/${{ steps.commit-info.outputs.branch_name }}}"
          PAYLOAD="${PAYLOAD//LEAD_TIME_SECONDS_PLACEHOLDER/${{ steps.lead-time.outputs.lead_time_seconds }}}"
          PAYLOAD="${PAYLOAD//REPOSITORY_PLACEHOLDER/${{ github.repository }}}"
          PAYLOAD="${PAYLOAD//WORKFLOW_RUN_PLACEHOLDER/${{ github.run_id }}}"

          echo "ðŸ“¤ Enviando dados para API..."
          echo "URL: $BACKEND_URL/api/dora/deployment"
          echo "Payload (sem informaÃ§Ãµes sensÃ­veis):"
          echo "$PAYLOAD" | grep -v "projectKey"

          # Fazer requisiÃ§Ã£o com timeout e retry
          MAX_RETRIES=3
          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
            if [ $RETRY_COUNT -gt 0 ]; then
              echo "ðŸ”„ Tentativa $(($RETRY_COUNT + 1)) de $MAX_RETRIES..."
              sleep 2
            fi

            RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 30 -X POST \
              "$BACKEND_URL/api/dora/deployment" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" || echo -e "\nERROR")

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')

            if [ "$HTTP_CODE" = "ERROR" ]; then
              echo "âš ï¸  Erro de conexÃ£o com a API"
              RETRY_COUNT=$((RETRY_COUNT + 1))
            elif [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "ðŸ“¡ Resposta da API:"
              echo "   Status HTTP: $HTTP_CODE"
              echo "   Corpo: $BODY"
              echo "âœ… Deployment registrado com sucesso!"
              SUCCESS=true
            else
              echo "ðŸ“¡ Resposta da API:"
              echo "   Status HTTP: $HTTP_CODE"
              echo "   Corpo: $BODY"
              echo "âŒ Erro ao registrar deployment"
              RETRY_COUNT=$((RETRY_COUNT + 1))
            fi
          done

          if [ "$SUCCESS" = "false" ]; then
            echo "âŒ Falha apÃ³s $MAX_RETRIES tentativas"
            exit 1
          fi

      - name: Resumo do Deployment
        if: always()
        run: |
          #!/bin/bash

          echo "ðŸ“‹ Resumo do Registro de Deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Projeto: fklearn"
          echo "Status: ${{ steps.commit-info.outputs.deployment_status }}"
          echo "Commit: ${{ steps.commit-info.outputs.commit_sha }}"
          echo "Lead Time: ${{ steps.lead-time.outputs.lead_time_minutes }} minutos"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "${{ steps.send-metrics.outcome }}" = "success" ]; then
            echo "âœ… MÃ©tricas DORA registradas com sucesso"
          else
            echo "âš ï¸  Houve problemas ao registrar as mÃ©tricas"
          fi
